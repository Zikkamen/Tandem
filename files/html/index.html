<!DOCTYPE html>
<style>
  .spare-piece-count {
    position: relative;
    display: inline;
    font-size: max(1.5vw, 1.5vh);
    bottom: 15px;
    right: 12px;
    background-color: white;
    color: black;
  }
  .flexcontainer {
    margin: auto;
    float: left;
    margin-left: auto;
    margin-right: auto;
    max-width: fit-content;
    padding: 10px;
  }
  .timings {
    margin-top: 10px;
    margin-bottom: 10px;
  }
</style>
<html lang="en">
  <head>
    <link rel="stylesheet" href="./files/css/chessboard-1.0.0.min.css">
  </head>
  <body id="body">
    <div style="max-width: 2560px;">
      <button type="button" onclick="resetGame()">Reset Game</button>
      <button type="button" onclick="onPressColor('W1')">White (Team1)</button>
      <button type="button" onclick="onPressColor('B2')">Black (Team1)</button>
      <button type="button" onclick="onPressColor('W2')">White (Team2)</button>
      <button type="button" onclick="onPressColor('B1')">Black (Team2)</button>
      <h2 id="current_team_display" style="margin: 0 auto 0  auto; width: fit-content;"></h2>
      <div style="position:relative; display: flex; flex-direction: row; flex-wrap: wrap; margin: 0 auto 0 auto; width: 95%; max-width: 130vh;">
        <div id="divMainBoard" class="flexcontainer" style="position: relative; min-width: 400px; width: 100%; max-width: 70vh; font-size: max(2.2vw, 4.0vh);">
          <p style="position: absolute; top: 3%;" class="timings">5:00</p>
          <p style="position: absolute; bottom: 3%;" class="timings">5:00</p>
          <div id="mainBoard"></div>
        </div>
        <div id="divSecondBoard" class="flexcontainer" style="position: relative; min-width: 300px; width: 50%; max-width: 50vh; font-size: max(1.5vw, 3.0vh);">
          <p style="position: absolute; top: 2%; float: left;" class="timings">5:00</p>
          <p style="position: absolute; bottom: 2%; float: left;" class="timings">5:00</p>
          <div id="secondBoard"></div>
        </div>
      </div>
    </div>
  </body>
</html>
<script src="./files/js/jquery-3.7.1.min.js"></script>
<script src="./files/js/chessboard-1.0.0.js"></script>
<script>
  const socket = new WebSocket("ws://localhost:9091");
  var mainBoard = null;
  var secondBoard = null;
  var color = 'W';
  var board = '1';
  var mainBoardData = null;
  var secondBoardData = null;
  var promotion_piece = null;
  var lastFen1 = null;
  var lastFen2 = null;

  function update_timings() {
    let time_main_white = mainBoardData["white_time"];
    let time_main_black = mainBoardData["black_time"];
    let time_second_white = secondBoardData["white_time"];
    let time_second_black = secondBoardData["black_time"];

    let timings_main = document.getElementById("divMainBoard").getElementsByClassName("timings");
    let timings_second = document.getElementById("divSecondBoard").getElementsByClassName("timings");

    if(color == 'W') {
      timings_main[0].innerText = time_main_black;
      timings_main[1].innerText = time_main_white;
      timings_second[0].innerText = time_second_white;
      timings_second[1].innerText = time_second_black;
    } else {
      timings_main[0].innerText = time_main_white;
      timings_main[1].innerText = time_main_black;
      timings_second[0].innerText = time_second_black;
      timings_second[1].innerText = time_second_white;
    }
  }

  function update_boards() {
    update_timings();

    let spare_main_white = mainBoardData["white_sp"];
    let spare_main_black = mainBoardData["black_sp"];
    let spare_second_white = secondBoardData["white_sp"];
    let spare_second_black = secondBoardData["black_sp"];

    let spare_pieces_main = document.getElementById("mainBoard").getElementsByClassName("spare-piece-count");
    let spare_pieces_seco = document.getElementById("secondBoard").getElementsByClassName("spare-piece-count");

    if(color == 'W') {
      update_spare_pieces(spare_pieces_main, spare_main_black, spare_main_white);
      update_spare_pieces(spare_pieces_seco, spare_second_white, spare_second_black);
    } else {
      update_spare_pieces(spare_pieces_main, spare_main_white, spare_main_black);
      update_spare_pieces(spare_pieces_seco, spare_second_black, spare_second_white);
    }

    if(lastFen1 != mainBoardData["fen"]) {
      mainBoard.position(mainBoardData["fen"], false);
      lastFen1 = mainBoardData["fen"];
    }

    if(lastFen2 != secondBoardData["fen"]) {
      secondBoard.position(secondBoardData["fen"], false);
      lastFen2 = secondBoardData["fen"];
    }
  }

  function update_spare_pieces(spare_pieces, sp1, sp2) {
    for(var i=0; i<5; i++) {
      spare_pieces[i].innerText = sp1[i];
    }

    for(var i=0; i<5; i++) {
      spare_pieces[i+5].innerText = sp2[i];
    }
  }

  socket.addEventListener("message", (event) => {
    last_event = event.data;

    console.log(event.data);
    let json = JSON.parse(event.data);

    if(board == '1') {
      mainBoardData = JSON.parse(json["board_1"]);
      secondBoardData = JSON.parse(json["board_2"]);
    } else {
      mainBoardData = JSON.parse(json["board_2"]);
      secondBoardData = JSON.parse(json["board_1"]);
    }

    update_boards();
  });

  function onDragStart1 (source, piece, position, orientation) {
    if ((orientation === 'white' && piece.search(/^w/) === -1) ||
        (orientation === 'black' && piece.search(/^b/) === -1)) {
      return false
    }
  }

  function onDragStart2 (source, piece, position, orientation) {
    console.log("Promotion Piece selected", promotion_piece);
    promotion_piece = source;

    return false;
  }

  function onPressColor(chosen_side) {
    if(board != chosen_side[1]) {
      let tmp = mainBoardData;
      mainBoardData = secondBoardData;
      secondBoardData = tmp;
    }

    switch(chosen_side) {
      case "W1":
        document.getElementById("current_team_display").innerText = "Team 1 (White)";
        break;
      case "W2":
        document.getElementById("current_team_display").innerText = "Team 2 (White)";
        break;
      case "B2":
        document.getElementById("current_team_display").innerText = "Team 1 (Black)";
        break;
      default:
        document.getElementById("current_team_display").innerText = "Team 2 (Black)";
        break;
    }

    color = chosen_side[0];
    board = chosen_side[1];
    
    if(color == 'W') {
      mainBoard.orientation('white');
      secondBoard.orientation('black');
    } else if(color == 'B') {
      mainBoard.orientation('black');
      secondBoard.orientation('white');
    }

    update_boards();
  }

  function resetGame() {
    socket.send("Reset Game");
  };

  function onDrop(source, target, piece, newPos, oldPos, orientation) {
    lastFen1 = null;

    if(source != target) {
      socket.send(board + ';' + color + ';' + source + ';' + target + ';' + piece + ';' + promotion_piece);
    }
  };

  var config_1 = {
    draggable: true,
    dropOffBoard: 'snapback',
    position: 'start',
    sparePieces: true,
    onDragStart: onDragStart1,
    onDrop: onDrop,
  };

  var config_2 = {
    draggable: true,
    dropOffBoard: 'snapback',
    position: 'start',
    sparePieces: true,
    onDragStart: onDragStart2,
  };

  document.getElementById("current_team_display").innerText = "Team 1 (White)";
  mainBoard = Chessboard('mainBoard', config_1);
  secondBoard = Chessboard('secondBoard', config_2);
  secondBoard.orientation('black');
</script>