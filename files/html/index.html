<!DOCTYPE html>
<style>
  .spare-piece-count {
    position: relative;
    display: inline;
    font-size: 1.5em;
    bottom: 15px;
    right: 12px;
    background-color: white;
    color: black;
  }
  .flexcontainer {
    margin-left: auto; 
    margin-right: auto;
  }
</style>
<html lang="en">
  <head>
    <link rel="stylesheet" href="./files/css/chessboard-1.0.0.min.css">
  </head>
  <body>
    <div style="max-width: 2560px;">
      <button type="button" onclick="resetGame()">Reset Game</button>
      <button type="button" onclick="onPressColor('W;1')">White (Team1)</button>
      <button type="button" onclick="onPressColor('B;2')">Black (Team1)</button>
      <button type="button" onclick="onPressColor('W;2')">White (Team2)</button>
      <button type="button" onclick="onPressColor('B;1')">Black (Team2)</button>
      <div style="position:relative; display: flex; flex-direction: row; align-items: center; flex-wrap: wrap; margin: 0 auto 0 auto; width: 90%;">
        <div id="mainBoard" class="flexcontainer" style="min-width: 400px; width: 40%;"></div>
        <div id="secondBoard" style="margin-left: 20px; min-width: 300px; width: 30%;" class="flexcontainer"></div>
      </div>
    </div>
  </body>
</html>
<script src="./files/js/jquery-3.7.1.min.js"></script>
<script src="./files/js/chessboard-1.0.0.js"></script>
<script>
  const socket = new WebSocket("ws://localhost:9091");
  var mainBoard = null;
  var secondBoard = null;
  var color = 'W';
  var board = '1';
  var fen1 = null;
  var fen2 = null;
  var promotion_piece = null;

  function update_boards() {
    if(board == '1') {
      mainBoard.position(fen1);
      secondBoard.position(fen2);
    } else {
      mainBoard.position(fen2);
      secondBoard.position(fen1);
    }

    let spare_pieces = document.getElementById("mainBoard").getElementsByClassName("spare-piece-count");

    for(var i=0; i<spare_pieces.length; i++) {
      spare_pieces[i].innerText = i;
      console.log(spare_pieces[i], i);
    }
  }

  socket.addEventListener("message", (event) => {
    let json = JSON.parse(event.data);
    console.log(event.data);

    fen1 = json["board_1"];
    fen2 = json["board_2"];

    update_boards();
  });

  function onDragStart1 (source, piece, position, orientation) {
    if ((orientation === 'white' && piece.search(/^w/) === -1) ||
        (orientation === 'black' && piece.search(/^b/) === -1)) {
      //return false
    }
  }

  function onDragStart2 (source, piece, position, orientation) {
    console.log("Promotion Piece selected", promotion_piece);
    promotion_piece = source;

    return false;
  }

  function onPressColor(chosen_side) {
    board = chosen_side[2];
    color = chosen_side[0];

    const b1 = document.getElementById("mainBoard");
    const b2 = document.getElementById("secondBoard");
    
    if(color == 'W') {
      mainBoard.orientation('white');
      secondBoard.orientation('black');
    } else {
      mainBoard.orientation('black');
      secondBoard.orientation('white');
    }

    update_boards();
  }

  function resetGame() {
    socket.send("Reset Game");
  };

  function onDrop(source, target, piece, newPos, oldPos, orientation) {
    if(source != target) {
      socket.send(board + ';' + color + ';' + source + ';' + target + ';' + piece + ';' + promotion_piece);
    }
  };

  var config_1 = {
    draggable: true,
    dropOffBoard: 'snapback',
    position: 'start',
    sparePieces: true,
    onDragStart: onDragStart1,
    onDrop: onDrop,
  };

  var config_2 = {
    draggable: true,
    dropOffBoard: 'snapback',
    position: 'start',
    sparePieces: true,
    onDragStart: onDragStart2,
  };

  mainBoard = Chessboard('mainBoard', config_1);
  secondBoard = Chessboard('secondBoard', config_2);
  secondBoard.orientation('black');
</script>